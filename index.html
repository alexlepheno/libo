<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maughan Library Book Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        #imageModal {
            transition: background-color 0.3s ease;
        }
        #modalContent {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes zoomOut {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(0.8); opacity: 0; }
        }
        .zoom-in { animation: zoomIn 0.3s ease-out forwards; }
        .zoom-out { animation: zoomOut 0.3s ease-in forwards; }

        .map-container {
            position: relative;
            width: 100%;
            cursor: pointer;
        }
        .map-container img, #modalImage {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        .map-container svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .room-highlight {
            fill: rgba(252, 211, 77, 0.5); /* Semi-transparent yellow */
            stroke: rgba(234, 179, 8, 0.9);
            stroke-width: 2;
        }
        .arrow-indicator {
            fill: #ef4444; /* Red color */
        }
        #modalImageContainer {
            position: relative;
        }
        #modalImageContainer svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        #modalImage {
            max-width: 90vw;
            max-height: 85vh;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Library Book Finder</h1>
                <p class="text-gray-500 mt-2">Enter a book's classmark to find its location.</p>
            </header>

            <main>
                <div class="flex flex-col md:flex-row gap-3">
                    <input type="text" id="classmarkInput" placeholder="e.g., DD237 or K60" class="flex-grow w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-300" autocomplete="off">
                    <button id="findButton" class="w-full md:w-auto bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                        Find
                    </button>
                </div>

                <div id="statusArea" class="text-center mt-4 text-gray-500 min-h-[24px]"></div>
                <div id="resultArea" class="mt-6"></div>
            </main>
        </div>
        <footer class="text-center text-gray-400 text-sm mt-4">
            <p>Data sourced from the Maughan Library browsing guide.</p>
            <p>made by Alexandre Laurent 2025</p>
        </footer>
    </div>

    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-0 flex items-center justify-center p-4 z-50 hidden">
        <div id="modalContent" class="relative text-center">
             <div id="modalRoomLabel" class="absolute -top-10 left-1/2 -translate-x-1/2 text-white text-xl font-bold bg-black/60 px-4 py-1 rounded-lg pointer-events-none"></div>
             <div id="modalImageContainer">
                 <img id="modalImage" src="" alt="Zoomed floor plan" />
                 <svg id="modalSvgOverlay" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
             </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & SETUP ---
        const CSV_DATA = `Subject,Beg,End,Room(s),Floor
[Humanities books] A-D,A1,B 171.A,1.58,1
[Humanities books] A-D,B 171.B,B 491.M,1.57,1
[Humanities books] A-D,B 491.M,BC 80.S,1.58,1
[Humanities books] A-D,BC 91.A,BL 1239.3,1.59,1
[Humanities books] A-D,BL 1241.4,BM 175.2,1.58,1
[Humanities books] A-D,BM 176.S,BM 726.W,1.56,1
[Humanities books] A-D,BM 729.A,BP 163.P,1.55,1
[Humanities books] A-D,BP 163.P,BR 60.C,1.54,1
[Humanities books] A-D,BR 60.C,BS 1545.2,1.55,1
[Humanities books] A-D,BS 1545.3,BS 2543.W,1.56,1
[Humanities books] A-D,BS 2545,BS 2651.P,1M.58,1M
[Humanities books] A-D,BS 2651.R,BT 75.R,1M.59,1M
[Humanities books] A-D,BT 75.S,BT 150.V,1M.58,1M
[Humanities books] A-D,BT 153.F,BT 734.3,1M.56,1M
[Humanities books] A-D,BT 736.H,BT 993.2,1M.55,1M
[Humanities books] A-D,BT 995,BV 5085.U,1M.54,1M
[Humanities books] A-D,BV 5090.F,BX 5141.A,1M.55,1M
[Humanities books] A-D,BX 5141.A,BX 9999,1M.56,1M
[Humanities books] A-D,C1,D 16.8.A,1.66,1
[Humanities books] A-D,D 16.8.B,D 117.C,1.67,1
[Humanities books] A-D,D 117.D,D 208.W,1.69,1
[Humanities books] A-D,D 208.W,D 640.B,1.70,1
[Humanities books] A-D,D 640.C,DA 16.B,1.71,1
[Humanities books] A-D,DA 16.C,DA 170.V,1.70,1
[Humanities books] A-D,DA 170.W,DA 560.D,1.69,1
[Humanities books] A-D,DA 560.E,DA 670.S8,1.68,1
[Humanities books] A-D,DA 670.S9,DD 109,1.67,1
[Humanities books] A-D,DD 110,DE 9999,1.66,1
[Humanities books] A-D,DF1,DF 759.W,1M.72,1M
[Humanities books] A-D,DF 765.A,DF 901.P,1M.71,1M
[Humanities books] A-D,DF 901.R,DG 311.S,1M.70,1M
[Humanities books] A-D,DG 311.W,DG 577.5,1M.69,1M
[Humanities books] A-D,DG 611.5,DJ 9999,1M.68,1M
[Humanities books] A-D,DJK 1,DP 48.F,1M.67,1M
[Humanities books] A-D,DP 48.F,DP 99.W,1M.66,1M
[Humanities books] A-D,DP 101.A,DR 9999,1.13,1
[Humanities books] A-D,DS 1,DS 272.F,1.13,1
[Humanities books] A-D,DS 272.K,DS 771.P,1.14,1
[Humanities books] A-D,DS 771.5,DT 352.5,1M.14,1M
[Humanities books] A-D,DT 352.6,DU 420.M,1M.13,1M
[Law books],HV1,HV 1441.G,1.26,1
[Law books],HV 1444.G,HV 9999,1.25,1
[Law books],HV 6025.0,HV 8197.A,1.24,1
[Law books],HV 1444.G,JX 1963.D,1.25,1
[Law books],JX 1963.D,JX 5531.B,1.26,1
[Law books],JX 5555,K 59.J,1.27,1
[Law books],K 60,K 215.E,1.35,1
[Law books],K 225.B,KBP 9999,1.35,1
[Law books],KBR1,KD 1480.W,1.36,1
[Law books],KD 1487,KD 5424.5,1.37,1
[Law books],KD 5429.M,KI 31.V,1.38,1
[Law books],KI 32.B,KJE 5156.Z,1.37,1
[Law books],KJE 5170.B,KLB 9999,1.36,1
[Law books],KM1,KP 19.M,1.35,1
[Law books],KP 19.N,KRA 395.G,1M.35,1M
[Law books],KRA 395.G,KX 111.L,1M.36,1M
[Law books],KX 114.W,KZ 224.1,1M.37,1M
[Law books],KZ 703.1,KZD 9999,1M.36-1M.35,1M
[Humanities books] E-Z,E1,E 840.8,2M.13-2M.16,2M
[Humanities books] E-Z,E1,E467.1,2M.16,2M
[Humanities books] E-Z,E 468.C,E744.F,2M.14,2M
[Humanities books] E-Z,E744.F,E840.8,2M.13,2M
[Humanities books] E-Z,E 841,GE 42.P,2.13,2
[Humanities books] E-Z,E 841,HC 241.2,2.13-2.14,2
[Humanities books] E-Z,GE 42.S,HC 59.7,2.14,2
[Humanities books] E-Z,HC 59.7,HC 241.2,2.13,2
[Humanities books] E-Z,HC 241.2,HC 257.W,2.44,2
[Humanities books] E-Z,HC 241.2,P9999,2.43-2.51,2
[Humanities books] E-Z,HC 258.B,HD 2785.W,2.43,2
[Humanities books] E-Z,HD 2791.K,HD 6052.W,2.44,2
[Humanities books] E-Z,HD 6053,HD 7287.5,2.45,2
[Humanities books] E-Z,HD 7287.6,HD 8943.S,2.46,2
[Humanities books] E-Z,HD 9000.D,HD 9753.U,2.47,2
[Humanities books] E-Z,HD 9744,HF 1359.B,2.48,2
[Humanities books] E-Z,HF 1359.B,HF 1411.F,2.49,2
[Humanities books] E-Z,HF 1411.G,HF 3778.G,2.50,2
[Humanities books] E-Z,HF 3785.T,HN 398.E,2.51,2
[Humanities books] E-Z,HN 398.E,HT 153.L,2.50,2
[Humanities books] E-Z,HT 153.R,HX 56.W,2.49,2
[Humanities books] E-Z,HX 72.S,JK 468.1,2.48,2
[Humanities books] E-Z,JK 468.1,JQ 5995,2.47,2
[Humanities books] E-Z,JS 67,ML 410.V,2.46,2
[Humanities books] E-Z,ML 422.B,NE 9999,2.45,2
[Humanities books] E-Z,NK 1,P 9999,2.44,2
[Humanities books] E-Z,PA1,PA 6392.H,2M.43-2M.51,2M
[Humanities books] E-Z,PA1,PA 3611.L,2M.43,2M
[Humanities books] E-Z,PA 3611.L,PA 4226.Z,2M.51,2M
[Humanities books] E-Z,PA 4227.E,PA 4336.G,2M.50,2M
[Humanities books] E-Z,PA 4360.C,PA 5284,2M.49,2M
[Humanities books] E-Z,PA 5285.B,PA 5610.R,2M.48,2M
[Humanities books] E-Z,PA 5610.S,PA 5612.X,2M.47,2M
[Humanities books] E-Z,PA 5613,PA 6120,2M.46,2M
[Humanities books] E-Z,PA 6121,PA 6296.D,2M.45,2M
[Humanities books] E-Z,PA 6296.D,PA 6392.H,2M.44,2M
[Humanities books] E-Z,PA 6393.A,PA 6568.C,2.56,2
[Humanities books] E-Z,PA 6393.A,PQ 645.S,"2.54-2.59",2
[Humanities books] E-Z,PA 6568.C,PA 6716.M,2.55,2
[Humanities books] E-Z,PA 6716.P,PA 8502.E,2.54,2
[Humanities books] E-Z,PA 8502.E,PN 94.6,2.55,2
[Humanities books] E-Z,PN 98.M,PN 1993.4,2.56,2
[Humanities books] E-Z,PN 1993.5.A,PN 1993.5.S,2.58,2
[Humanities books] E-Z,PN 1993.5.S,PN 1995.C,2.57,2
[Humanities books] E-Z,PN 1995.9,PN 1998.3,2.58,2
[Humanities books] E-Z,PN 1998.3,PQ 295.D,2.59,2
[Humanities books] E-Z,PQ 245.B,PQ 645.S,2.58,2
[Humanities books] E-Z,PQ 648.B,PQ 6606,"2M.54-2M.59",2M
[Humanities books] E-Z,PQ 648.B,PQ 1779.T,2M.58,2M
[Humanities books] E-Z,PQ 1781.D,PQ 2242.R,2M.59,2M
[Humanities books] E-Z,PQ 2246,PQ 2436.S,2M.58,2M
[Humanities books] E-Z,PQ 2438.G,PQ 2603.U,2M.56,2M
[Humanities books] E-Z,PQ 2605,PQ 2606,2M.55,2M
[Humanities books] E-Z,PQ 2607,PQ 2638.L,2M.54,2M
[Humanities books] E-Z,PQ 2639,PQ 6389.P,2M.55,2M
[Humanities books] E-Z,PQ 6390.E,PQ 6606,2M.56,2M
[Humanities books] E-Z,PQ 6607,PQ 6623.A79,2.64,2
[Humanities books] E-Z,PQ 6607.E,PT 1479.R,"2.62-2.71",2
[Humanities books] E-Z,PQ 6623.A8,PQ 7297,2.63,2
[Humanities books] E-Z,PQ 7298,PQ 8497.A,2.62,2
[Humanities books] E-Z,PQ 8497.B,PQ 9261.M69,2.63,2
[Humanities books] E-Z,PQ 9261.M7,PQ 9697.S,2.62,2
[Humanities books] E-Z,PQ 9697.T,PR 99,2.63,2
[Humanities books] E-Z,PR 100,PR 549,2.64,2
[Humanities books] E-Z,PR 550,PR 929,2.66,2
[Humanities books] E-Z,PR 930,PR 1149,2.67,2
[Humanities books] E-Z,PR 1150,PR 1579,2.69,2
[Humanities books] E-Z,PR 1580,PR 2009,2.70,2
[Humanities books] E-Z,PR 2010,PR 3522.F,2.71,2
[Humanities books] E-Z,PR 3522.G,PR 4965,2.70,2
[Humanities books] E-Z,PR 4966,PR 6019.O9.24,2.69,2
[Humanities books] E-Z,PR 6019.O9.Z5,PR 6054,2.68,2
[Humanities books] E-Z,PR 6055,PS 3545.L,2.67,2
[Humanities books] E-Z,PS 3545.M,PT 1099,2.66,2
[Humanities books] E-Z,PT 1100,ZA 9999,"2M.62-2M.72",2M
[Humanities books] E-Z,PT 1100,PT 1567,2M.65,2M
[Humanities books] E-Z,PT 1568,PT 1892,2M.64,2M
[Humanities books] E-Z,PT 1893,PT 2360,2M.63,2M
[Humanities books] E-Z,PT 2361,PT 2467,2M.62,2M
[Humanities books] E-Z,PT 2468,PT 2616,2M.63,2M
[Humanities books] E-Z,PT 2617,PT 2625.A44.Z48,2M.62,2M
[Humanities books] E-Z,PT 2625.A44.249,PT 2638.M,2M.63,2M
[Humanities books] E-Z,PT 2638.N,PT 2685.O36.24,2M.64,2M
[Humanities books] E-Z,PT 2685.O36.25,PZ 9999,2M.65,2M
[Humanities books] E-Z,U1,U27.K,2M.72,2M
[Humanities books] E-Z,U 27.L,U815.K,2M.71,2M
[Humanities books] E-Z,U 815.L,UA 831.D,2M.70,2M
[Humanities books] E-Z,UA 831.E,UB 251.U5.G,2M.69,2M
[Humanities books] E-Z,UB 251.U5.H,UG 630.R,2M.68,2M
[Humanities books] E-Z,UG 630.S,Z 1008.0,2M.67,2M
[Humanities books] E-Z,Z 1008.0,ZA 9999,2M.66,2M
[Science books],Q1,QA 76.G,2.35,2
[Science books],QA 76.H,QA 76.9,2.36,2
[Science books],QA 76.9,QA 267.L,2.37,2
[Science books],QA 267.M,QA 303.R,2.38,2
[Science books],QA 303.S,QA 326.M,2.37,2
[Science books],QA 326.N,QA 351.0,2.36,2
[Science books],QA 351.R,QA 387.2,2.35,2
[Science books],QA 400,QC 61.L,"2M.35-2M.37",2M
[Science books],QA 400,QA 471.H,2M.35,2M
[Science books],QA 471.M,QA 802.2,2M.36,2M
[Science books],QA 803.C,QC 6.C,2M.37,2M
[Science books],QC 6.D,QC 20.6,2M.36,2M
[Science books],QC 20.7,QC 61.L,2M.35,2M
[Science books],QC 70,QC 278.W,2.40,2
[Science books],QC 280,QC 670.R,2.41,2
[Science books],QC 670.S,QE 665,2.42,2
[Science books],QE 681.A,QU 9999,2.41,2
[Science books],R1,R 855.3,2.41,2
[Science books],R 855.3,RA 441.B,2.40,2
[Science books],RA 441.C,TX 9999,"2M.39-2M.42",2M
[Science books],RA 441.C,RC 552.E,2M.40,2M
[Science books],RC 552.P,TD 892.L,2M.39,2M
[Science books],TD 892.R,TJ 755.G,2M.40,2M
[Science books],TJ 755.G,TK 5102.5,2M.41,2M
[Science books],TK 5102.5,TK 7882.S,2M.42,2M
[Science books],TK 7882.S,TX 9999,2M.41,2M
[Humanities books] Folio & Outsize,FOL A 1,ZA 9999,"2M.17-2M.20",2M
[Humanities books] Folio & Outsize,FOL A 1,BR 60.M58,2M.20,2M
[Humanities books] Folio & Outsize,FOL. BR 60.M58,BR 70.08,2M.19,2M
[Humanities books] Folio & Outsize,FOL. BR 70.CB,N 6853.P,2M.18,2M
[Humanities books] Folio & Outsize,FOL. N 6860,ND 145.B,2M.17,2M
[Humanities books] Folio & Outsize,FOL ND 170.N,PA 3309,2M.18,2M
[Humanities books] Folio & Outsize,FOL. PA 3315.0,UA 23.S,2M.19,2M
[Humanities books] Folio & Outsize,FOL UA 23.2,ZA 9999,2M.20,2M
[Humanities books] Folio & Outsize,OUTSIZE A 1,ZA 9999,"2M.12-2M.13",2M
[Humanities books] Folio & Outsize,OUTSIZE A 1,CN 520.0,2M.13,2M
[Humanities books] Folio & Outsize,OUTSIZE CN 520.C,ZA 9999,2M.12,2M
[Humanities books] Folio & Outsize,Atlases,,2M.12,2M`;
        
        // --- PRECISE ROOM COORDINATES ---
        const ROOM_COORDINATES = {
            '1': {
                '1.13': { x: 0.5273, y: 0.5117, w: 0.0374, h: 0.1045, r: 0 }, '1.14': { x: 0.5647, y: 0.5117, w: 0.0402, h: 0.0990, r: 0 },
                '1.24': { x: 0.8290, y: 0.0385, w: 0.0546, h: 0.1045, r: 0 }, '1.25': { x: 0.8290, y: 0.1431, w: 0.0575, h: 0.0660, r: 0 },
                '1.26': { x: 0.8319, y: 0.2091, w: 0.0517, h: 0.0605, r: 0 }, '1.27': { x: 0.8290, y: 0.2724, w: 0.0546, h: 0.0660, r: 0 },
                '1.35': { x: 0.8319, y: 0.5365, w: 0.0517, h: 0.0660, r: 0 }, '1.36': { x: 0.8319, y: 0.6025, w: 0.0489, h: 0.0605, r: 0 },
                '1.37': { x: 0.8319, y: 0.6685, w: 0.0517, h: 0.0605, r: 0 }, '1.38': { x: 0.8290, y: 0.7291, w: 0.0747, h: 0.1155, r: 0 },
                '1.39': { x: 0.7601, y: 0.7015, w: 0.0517, h: 0.0935, r: 0 }, '1.40': { x: 0.7256, y: 0.6850, w: 0.0316, h: 0.1155, r: 0 },
                '1.41': { x: 0.6853, y: 0.6850, w: 0.0402, h: 0.1100, r: 0 }, '1.42': { x: 0.6135, y: 0.6685, w: 0.0747, h: 0.1651, r: 0 },
                '1.43': { x: 0.5675, y: 0.6465, w: 0.0316, h: 0.1045, r: 0 }, '1.44': { x: 0.5302, y: 0.6465, w: 0.0374, h: 0.1100, r: 0 },
                '1.45': { x: 0.4957, y: 0.6465, w: 0.0345, h: 0.1045, r: 0 }, '1.46': { x: 0.4555, y: 0.6465, w: 0.0402, h: 0.1100, r: 0 },
                '1.47': { x: 0.4210, y: 0.6465, w: 0.0374, h: 0.1045, r: 0 }, '1.48': { x: 0.3865, y: 0.6465, w: 0.0345, h: 0.1045, r: 0 },
                '1.49': { x: 0.3520, y: 0.6465, w: 0.0345, h: 0.1045, r: 0 }, '1.50': { x: 0.3175, y: 0.6465, w: 0.0345, h: 0.1045, r: 0 },
                '1.51': { x: 0.2802, y: 0.6465, w: 0.0374, h: 0.1100, r: 0 }, '1.54': { x: 0.2457, y: 0.7456, w: 0.0345, h: 0.0660, r: 0 },
                '1.55': { x: 0.2284, y: 0.8116, w: 0.0575, h: 0.1100, r: 0 }, '1.56': { x: 0.1911, y: 0.8116, w: 0.0374, h: 0.1100, r: 0 },
                '1.57': { x: 0.1595, y: 0.8941, w: 0.0316, h: 0.0330, r: 0 }, '1.58': { x: 0.1164, y: 0.8116, w: 0.0431, h: 0.1100, r: 0 },
                '1.59': { x: 0.0618, y: 0.8501, w: 0.0546, h: 0.0770, r: 0 }, '1.66': { x: 0.1882, y: 0.5145, w: 0.0345, h: 0.1094, r: 0 },
                '1.67': { x: 0.2256, y: 0.5145, w: 0.0345, h: 0.1045, r: 0 }, '1.68': { x: 0.2572, y: 0.5145, w: 0.0201, h: 0.1045, r: 0 },
                '1.69': { x: 0.2802, y: 0.5145, w: 0.0345, h: 0.1045, r: 0 }, '1.70': { x: 0.3147, y: 0.5145, w: 0.0287, h: 0.1155, r: 0 },
                '1.71': { x: 0.3463, y: 0.5145, w: 0.0402, h: 0.1045, r: 0 },
            },
            '1M': {
                '1M.12': { x: 0.4813, y: 0.5268, w: 0.0517, h: 0.0873, r: 0 }, '1M.13': { x: 0.5330, y: 0.5213, w: 0.0374, h: 0.0928, r: 0 },
                '1M.14': { x: 0.5675, y: 0.5268, w: 0.0374, h: 0.0819, r: 0 }, '1M.35': { x: 0.8319, y: 0.5323, w: 0.0431, h: 0.0710, r: 0 },
                '1M.36': { x: 0.8319, y: 0.5978, w: 0.0431, h: 0.0655, r: 0 }, '1M.37': { x: 0.8348, y: 0.6633, w: 0.0489, h: 0.0655, r: 0 },
                '1M.38': { x: 0.8319, y: 0.7288, w: 0.0718, h: 0.0873, r: 0 }, '1M.39': { x: 0.7629, y: 0.7015, w: 0.0517, h: 0.0601, r: 0 },
                '1M.40': { x: 0.7256, y: 0.6851, w: 0.0374, h: 0.0710, r: 0 }, '1M.41': { x: 0.6882, y: 0.6797, w: 0.0402, h: 0.0764, r: 0 },
                '1M.42': { x: 0.6394, y: 0.6906, w: 0.0460, h: 0.0655, r: 0 }, '1M.43': { x: 0.5675, y: 0.6469, w: 0.0374, h: 0.0655, r: 0 },
                '1M.44': { x: 0.5302, y: 0.6469, w: 0.0374, h: 0.0710, r: 0 }, '1M.45': { x: 0.4986, y: 0.6469, w: 0.0316, h: 0.0710, r: 0 },
                '1M.46': { x: 0.4612, y: 0.6469, w: 0.0402, h: 0.0655, r: 0 }, '1M.47': { x: 0.4210, y: 0.6414, w: 0.0402, h: 0.0764, r: 0 },
                '1M.48': { x: 0.3922, y: 0.6469, w: 0.0287, h: 0.0655, r: 0 }, '1M.49': { x: 0.3549, y: 0.6469, w: 0.0345, h: 0.0655, r: 0 },
                '1M.50': { x: 0.3204, y: 0.6469, w: 0.0345, h: 0.0655, r: 0 }, '1M.51': { x: 0.2830, y: 0.6414, w: 0.0402, h: 0.1037, r: 0 },
                '1M.54': { x: 0.2486, y: 0.7397, w: 0.0374, h: 0.0710, r: 0 }, '1M.55': { x: 0.2342, y: 0.8107, w: 0.0402, h: 0.0983, r: 0 },
                '1M.56': { x: 0.1940, y: 0.8052, w: 0.0431, h: 0.0819, r: 0 }, '1M.58': { x: 0.1250, y: 0.8052, w: 0.0402, h: 0.0873, r: 0 },
                '1M.59': { x: 0.0848, y: 0.8380, w: 0.0402, h: 0.0764, r: 0 }, '1M.66': { x: 0.1911, y: 0.5241, w: 0.0374, h: 0.0873, r: 0 },
                '1M.67': { x: 0.2284, y: 0.5268, w: 0.0345, h: 0.0873, r: 0 }, '1M.68': { x: 0.2658, y: 0.5268, w: 0.0201, h: 0.0819, r: 0 },
                '1M.69': { x: 0.2830, y: 0.5268, w: 0.0345, h: 0.0873, r: 0 }, '1M.70': { x: 0.3204, y: 0.5268, w: 0.0374, h: 0.0819, r: 0 },
                '1M.71': { x: 0.3578, y: 0.5268, w: 0.0287, h: 0.0873, r: 0 }, '1M.72': { x: 0.3865, y: 0.5268, w: 0.0517, h: 0.0873, r: 0 },
            },
            '2': {
                '2.13': { x: 0.5273, y: 0.5197, w: 0.0402, h: 0.0985, r: 0 }, '2.14': { x: 0.5647, y: 0.5197, w: 0.0374, h: 0.0985, r: 0 },
                '2.18': { x: 0.6624, y: 0.5197, w: 0.0431, h: 0.1422, r: 0 }, '2.19': { x: 0.6997, y: 0.5197, w: 0.0431, h: 0.1368, r: 0 },
                '2.20': { x: 0.7399, y: 0.5142, w: 0.0431, h: 0.1422, r: 0 }, '2.25': { x: 0.8319, y: 0.1477, w: 0.0575, h: 0.0602, r: 0 },
                '2.26': { x: 0.8348, y: 0.2079, w: 0.0575, h: 0.0711, r: 0 }, '2.27': { x: 0.8319, y: 0.2735, w: 0.0575, h: 0.0711, r: 0 },
                '2.38': { x: 0.8319, y: 0.7331, w: 0.0776, h: 0.1149, r: 0 }, '2.39': { x: 0.7601, y: 0.7002, w: 0.0575, h: 0.1094, r: 0 },
                '2.40': { x: 0.7284, y: 0.6838, w: 0.0345, h: 0.1204, r: 0 }, '2.41': { x: 0.6853, y: 0.6838, w: 0.0431, h: 0.1149, r: 0 },
                '2.42': { x: 0.6106, y: 0.6619, w: 0.0833, h: 0.1751, r: 0 }, '2.43': { x: 0.5647, y: 0.6455, w: 0.0374, h: 0.1094, r: 0 },
                '2.44': { x: 0.5302, y: 0.6565, w: 0.0402, h: 0.1094, r: 0 }, '2.45': { x: 0.4957, y: 0.6455, w: 0.0374, h: 0.1149, r: 0 },
                '2.46': { x: 0.4555, y: 0.6455, w: 0.0431, h: 0.1149, r: 0 }, '2.47': { x: 0.4181, y: 0.6510, w: 0.0460, h: 0.1039, r: 0 },
                '2.48': { x: 0.3865, y: 0.6455, w: 0.0374, h: 0.1094, r: 0 }, '2.49': { x: 0.3491, y: 0.6510, w: 0.0402, h: 0.1039, r: 0 },
                '2.50': { x: 0.3147, y: 0.6510, w: 0.0374, h: 0.1039, r: 0 }, '2.51': { x: 0.2802, y: 0.6510, w: 0.0431, h: 0.1039, r: 0 },
                '2.54': { x: 0.2457, y: 0.7495, w: 0.0345, h: 0.0656, r: 0 }, '2.55': { x: 0.2284, y: 0.8096, w: 0.0575, h: 0.1204, r: 0 },
                '2.56': { x: 0.1911, y: 0.8151, w: 0.0402, h: 0.1094, r: 0 }, '2.57': { x: 0.1566, y: 0.9026, w: 0.0345, h: 0.0219, r: 0 },
                '2.58': { x: 0.1193, y: 0.8151, w: 0.0374, h: 0.1094, r: 0 }, '2.59': { x: 0.0618, y: 0.8534, w: 0.0546, h: 0.0711, r: 0 },
                '2.62': { x: 0.0675, y: 0.7166, w: 0.0776, h: 0.0930, r: 0 }, '2.63': { x: 0.0790, y: 0.6619, w: 0.0805, h: 0.0821, r: 0 },
                '2.64': { x: 0.1049, y: 0.5799, w: 0.0862, h: 0.0985, r: 0 }, '2.66': { x: 0.1882, y: 0.5142, w: 0.0345, h: 0.1039, r: 0 },
                '2.67': { x: 0.2256, y: 0.5197, w: 0.0345, h: 0.0930, r: 0 }, '2.68': { x: 0.2601, y: 0.5142, w: 0.0201, h: 0.1039, r: 0 },
                '2.69': { x: 0.2773, y: 0.5197, w: 0.0402, h: 0.1039, r: 0 }, '2.70': { x: 0.3147, y: 0.5142, w: 0.0345, h: 0.1094, r: 0 },
                '2.71': { x: 0.3491, y: 0.5197, w: 0.0374, h: 0.0985, r: 0 },
            },
            '2M': {
                '2M.12': { x: 0.4784, y: 0.5225, w: 0.0489, h: 0.0875, r: 0 }, '2M.13': { x: 0.5273, y: 0.5225, w: 0.0402, h: 0.0875, r: 0 },
                '2M.14': { x: 0.5647, y: 0.5225, w: 0.0374, h: 0.0875, r: 0 }, '2M.16': { x: 0.6020, y: 0.5225, w: 0.0345, h: 0.0875, r: 0 },
                '2M.17': { x: 0.6336, y: 0.5225, w: 0.0345, h: 0.0328, r: 0 }, '2M.18': { x: 0.6710, y: 0.5225, w: 0.0374, h: 0.1204, r: 0 },
                '2M.19': { x: 0.6997, y: 0.5279, w: 0.0431, h: 0.1149, r: 0 }, '2M.20': { x: 0.7428, y: 0.5279, w: 0.0402, h: 0.1204, r: 0 },
                '2M.25': { x: 0.8348, y: 0.1286, w: 0.0489, h: 0.0656, r: 0 }, '2M.26': { x: 0.8348, y: 0.1942, w: 0.0489, h: 0.0602, r: 0 },
                '2M.27': { x: 0.8348, y: 0.2599, w: 0.0489, h: 0.0656, r: 0 }, '2M.35': { x: 0.8348, y: 0.5279, w: 0.0460, h: 0.0656, r: 0 },
                '2M.36': { x: 0.8348, y: 0.5991, w: 0.0489, h: 0.0602, r: 0 }, '2M.37': { x: 0.8376, y: 0.6647, w: 0.0489, h: 0.0547, r: 0 },
                '2M.38': { x: 0.8348, y: 0.7249, w: 0.0776, h: 0.0985, r: 0 }, '2M.39': { x: 0.7629, y: 0.7030, w: 0.0517, h: 0.0656, r: 0 },
                '2M.40': { x: 0.7256, y: 0.6811, w: 0.0374, h: 0.0875, r: 0 }, '2M.41': { x: 0.6767, y: 0.6811, w: 0.0517, h: 0.0821, r: 0 },
                '2M.42': { x: 0.6394, y: 0.6811, w: 0.0431, h: 0.0821, r: 0 }, '2M.43': { x: 0.5647, y: 0.6428, w: 0.0402, h: 0.0711, r: 0 },
                '2M.44': { x: 0.5273, y: 0.6428, w: 0.0431, h: 0.0766, r: 0 }, '2M.45': { x: 0.4899, y: 0.6428, w: 0.0431, h: 0.0766, r: 0 },
                '2M.46': { x: 0.4555, y: 0.6428, w: 0.0431, h: 0.0766, r: 0 }, '2M.47': { x: 0.4152, y: 0.6428, w: 0.0402, h: 0.0766, r: 0 },
                '2M.48': { x: 0.3836, y: 0.6483, w: 0.0345, h: 0.0656, r: 0 }, '2M.49': { x: 0.3463, y: 0.6428, w: 0.0431, h: 0.0711, r: 0 },
                '2M.50': { x: 0.3118, y: 0.6428, w: 0.0345, h: 0.0821, r: 0 }, '2M.51': { x: 0.2716, y: 0.6428, w: 0.0431, h: 0.0985, r: 0 },
                '2M.54': { x: 0.2371, y: 0.7413, w: 0.0374, h: 0.0711, r: 0 }, '2M.55': { x: 0.2256, y: 0.8124, w: 0.0287, h: 0.1039, r: 0 },
                '2M.56': { x: 0.1825, y: 0.8124, w: 0.0402, h: 0.0821, r: 0 }, '2M.58': { x: 0.1106, y: 0.8124, w: 0.0374, h: 0.0930, r: 0 },
                '2M.59': { x: 0.0647, y: 0.8452, w: 0.0460, h: 0.0766, r: 0 }, '2M.62': { x: 0.0704, y: 0.7468, w: 0.0632, h: 0.0602, r: 0 },
                '2M.63': { x: 0.0905, y: 0.6538, w: 0.0718, h: 0.0930, r: 0 }, '2M.64': { x: 0.1106, y: 0.5936, w: 0.0603, h: 0.0656, r: 0 },
                '2M.65': { x: 0.1250, y: 0.5060, w: 0.0661, h: 0.0985, r: 0 }, '2M.66': { x: 0.1767, y: 0.5252, w: 0.0402, h: 0.0875, r: 0 },
                '2M.67': { x: 0.2170, y: 0.5225, w: 0.0374, h: 0.0875, r: 0 }, '2M.68': { x: 0.2514, y: 0.5170, w: 0.0201, h: 0.0930, r: 0 },
                '2M.69': { x: 0.2716, y: 0.5225, w: 0.0402, h: 0.0930, r: 0 }, '2M.70': { x: 0.3089, y: 0.5225, w: 0.0374, h: 0.0875, r: 0 },
                '2M.71': { x: 0.3463, y: 0.5225, w: 0.0374, h: 0.0821, r: 0 }, '2M.72': { x: 0.3807, y: 0.5225, w: 0.0517, h: 0.0875, r: 0 },
            }
        };

        let libraryData = [];
        const findButton = document.getElementById('findButton');
        const classmarkInput = document.getElementById('classmarkInput');
        const statusArea = document.getElementById('statusArea');
        const resultArea = document.getElementById('resultArea');
        const imageModal = document.getElementById('imageModal');
        const modalContent = document.getElementById('modalContent');
        const modalRoomLabel = document.getElementById('modalRoomLabel');
        const modalImageContainer = document.getElementById('modalImageContainer');
        const modalImage = document.getElementById('modalImage');
        const modalSvgOverlay = document.getElementById('modalSvgOverlay');

        // --- 2. DATA PARSING & INITIALIZATION ---
        function loadPapaParse(callback) {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js';
            script.onload = callback;
            document.head.appendChild(script);
        }

        function loadLibraryData() {
            try {
                libraryData = Papa.parse(CSV_DATA, { header: true, skipEmptyLines: true }).data;
            } catch (error) {
                statusArea.textContent = 'Error: Could not parse library data.';
            }
        }
        
        // --- 3. CORE SEARCH LOGIC ---
        function normalizeForSort(str) {
            if (!str || typeof str !== 'string') return '';

            // Clean the string: uppercase and remove all spaces for consistency.
            const cleanStr = str.toUpperCase().replace(/\s/g, '');

            // Separate the initial block of letters from the rest of the string.
            const match = cleanStr.match(/^([A-Z]+)(.*)/);

            // If the string doesn't start with letters (e.g., a special case like "Atlases"), return it as is.
            if (!match) return cleanStr; 

            const [, letters, rest] = match;

            // Pad the initial letters to a fixed length with spaces. This is the crucial step.
            // It ensures that prefixes of different lengths are sorted correctly
            // (e.g., 'B' is treated as less than 'BC').
            const paddedLetters = letters.padEnd(8, ' ');

            // Pad all number sequences found in the remainder of the string with leading zeros.
            // This ensures that numerical parts are compared by value, not as strings (e.g., 100 > 20).
            const paddedRest = rest.replace(/(\d+)/g, num => num.padStart(8, '0'));

            // Combine the parts to create a final, comparable string.
            return `${paddedLetters}${paddedRest}`;
        }

        function parseRoomString(roomStr) {
            if (!roomStr || typeof roomStr !== 'string') return [];
            const rooms = [];
            const roomMatches = roomStr.match(/([A-Z0-9]+\.[0-9]+)/g) || [];
            if (roomStr.includes('-') && roomMatches.length === 2) {
                const [start, end] = roomMatches;
                const startPrefixMatch = start.match(/^([A-Z0-9]+\.)/);
                const endPrefixMatch = end.match(/^([A-Z0-9]+\.)/);
                if (startPrefixMatch && endPrefixMatch && startPrefixMatch[1] === endPrefixMatch[1]) {
                    const prefix = startPrefixMatch[1];
                    const startNum = parseInt(start.replace(prefix, ''), 10);
                    const endNum = parseInt(end.replace(prefix, ''), 10);
                    if (!isNaN(startNum) && !isNaN(endNum) && startNum <= endNum) {
                        for (let i = startNum; i <= endNum; i++) rooms.push(prefix + i);
                        return rooms;
                    }
                }
            }
            return roomMatches;
        }

        function findBookLocation(userInput) {
            const normalizedInput = normalizeForSort(userInput);
            if (!normalizedInput) return null;
            for (const row of libraryData) {
                const begin = normalizeForSort(row.Beg);
                if (!row.End && normalizedInput === begin) return row;
            }
            for (const row of libraryData) {
                const begin = normalizeForSort(row.Beg);
                const end = normalizeForSort(row.End);
                if (end && normalizedInput >= begin && normalizedInput <= end) return row;
            }
            return null;
        }

        // --- 4. MODAL & DISPLAY LOGIC ---
        function openModal(imageSrc, svgContent, roomLabel) {
            modalImage.src = imageSrc;
            modalImage.onload = () => {
                modalSvgOverlay.innerHTML = svgContent;
                modalRoomLabel.textContent = `Room(s): ${roomLabel}`;
                imageModal.classList.remove('hidden');
                setTimeout(() => {
                    imageModal.classList.add('bg-opacity-75');
                    modalContent.classList.add('zoom-in');
                }, 10);
            }
        }

        function closeModal() {
            imageModal.classList.remove('bg-opacity-75');
            modalContent.classList.remove('zoom-in');
            modalContent.classList.add('zoom-out');
            setTimeout(() => {
                imageModal.classList.add('hidden');
                modalContent.classList.remove('zoom-out');
            }, 300);
        }

        function displayResult(result) {
            resultArea.innerHTML = '';
            if (!result) {
                resultArea.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg fade-in" role="alert">
                        <p class="font-bold">Not Found</p><p>We couldn't find a location for that classmark. Please check for typos.</p>
                    </div>`;
                return;
            }
            
            const floor = result.Floor;
            let imagePath = '';
            if (floor === '1') imagePath = 'https://raw.githubusercontent.com/alexlepheno/libo/cd3fd65b190f7dc63af2e59096cb7e5569c3ac48/floor-plan-1.jpg';
            else if (floor === '1M') imagePath = 'https://raw.githubusercontent.com/alexlepheno/libo/cd3fd65b190f7dc63af2e59096cb7e5569c3ac48/floor-plan-1M.png';
            else if (floor === '2') imagePath = 'https://raw.githubusercontent.com/alexlepheno/libo/cd3fd65b190f7dc63af2e59096cb7e5569c3ac48/floor-plan-2.jpg';
            else if (floor === '2M') imagePath = 'https://raw.githubusercontent.com/alexlepheno/libo/cd3fd65b190f7dc63af2e59096cb7e5569c3ac48/floor-plan-2M.jpg';

            const roomsToHighlight = parseRoomString(result['Room(s)']);
            const floorCoords = ROOM_COORDINATES[floor];
            let svgContent = '';

            if (floorCoords) {
                roomsToHighlight.forEach(roomNumber => {
                    const coords = floorCoords[roomNumber];
                    if (coords) {
                        const x = coords.x * 100, y = coords.y * 100, w = coords.w * 100, h = coords.h * 100;
                        const transform = coords.r ? `rotate(${coords.r} ${x + w/2} ${y + h/2})` : '';
                        
                        svgContent += `<rect x="${x}%" y="${y}%" width="${w}%" height="${h}%" class="room-highlight" transform="${transform}" />`;
                        
                        const arrowSize = 2.5; 
                        const centerX = x + w / 2;
                        let arrowY, arrowPath;
                        if ((y + h / 2) < 50) {
                            arrowY = y - arrowSize - 1;
                            arrowPath = `M${centerX - arrowSize/2},${arrowY + arrowSize} L${centerX},${arrowY} L${centerX + arrowSize/2},${arrowY + arrowSize} Z`;
                        } else {
                            arrowY = y + h + 1;
                            arrowPath = `M${centerX - arrowSize/2},${arrowY} L${centerX},${arrowY + arrowSize} L${centerX + arrowSize/2},${arrowY} Z`;
                        }
                        svgContent += `<path d="${arrowPath}" class="arrow-indicator" />`;
                    }
                });
            }

            resultArea.innerHTML = `
                <div class="bg-green-100 border-l-4 border-green-500 p-6 rounded-lg shadow-sm fade-in">
                    <div class="md:grid md:grid-cols-2 md:gap-6 items-start">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Location Found!</h2>
                            <div class="space-y-2">
                                <p><strong class="w-24 inline-block text-gray-600">Room(s):</strong> <span class="text-2xl font-bold text-green-700">${result['Room(s)'] || 'N/A'}</span></p>
                                <p><strong class="w-24 inline-block text-gray-600">Collection:</strong> <span class="font-medium text-gray-700">${result.Subject || 'N/A'}</span></p>
                                <p><strong class="w-24 inline-block text-gray-600">Floor:</strong> <span class="font-medium text-gray-700">${result.Floor || 'N/A'}</span></p>
                            </div>
                        </div>
                        ${imagePath ? `
                        <div class="mt-4 md:mt-0">
                            <h3 class="font-semibold text-gray-700 mb-2">Floor Plan (${result.Floor})</h3>
                            <div class="map-container">
                                <img src="${imagePath}" alt="Floor plan for floor ${result.Floor}" class="border-2 border-gray-300">
                                <svg viewBox="0 0 100 100" preserveAspectRatio="none">${svgContent}</svg>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>`;

            const mapContainer = resultArea.querySelector('.map-container');
            if (mapContainer) {
                mapContainer.addEventListener('click', (e) => {
                    e.preventDefault();
                    openModal(imagePath, svgContent, result['Room(s)']);
                });
            }
        }
        
        // --- 5. EVENT LISTENERS ---
        function performSearch() {
            const query = classmarkInput.value.trim();
            if (!query) {
                statusArea.textContent = 'Please enter a classmark.';
                return;
            }
            statusArea.textContent = '';
            const location = findBookLocation(query);
            displayResult(location);
        }

        findButton.addEventListener('click', performSearch);
        classmarkInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') performSearch();
        });
        
        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) closeModal();
        });

        // --- 6. INITIALIZATION ---
        loadPapaParse(loadLibraryData);
    </script>
</body>
</html>
